{% extends 'spots/base.html' %}

{% block title %}スポット投稿 - 旅ログマップ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-plus me-2"></i>新しいスポットを投稿</h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">スポット名 *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">説明 *</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="id_tags_text" class="form-label">タグ（任意）</label>
                        {{ form.tags_text }}
                        <div class="form-text">カンマ区切りで入力（例: 海, 山, 絶景）</div>
                    </div>

                    <!-- かんたん位置選択 -->
                    <div class="mb-3">
                        <label class="form-label">地図で位置を選択（任意）</label>
                        <div class="input-group mb-2">
                            <input type="text" id="placeSearchInput" class="form-control" placeholder="住所や施設名で検索">
                            <button type="button" id="placeSearchBtn" class="btn btn-outline-primary">
                                <i class="fas fa-search me-1"></i>検索
                            </button>
                            <button type="button" id="useMyLocationBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-location-arrow me-1"></i>現在地
                            </button>
                        </div>
                        <div id="pickMap" style="height: 320px; width: 100%;" class="rounded border"></div>
                        <div class="form-text">地図をクリックすると緯度・経度に自動入力されます。</div>
                        <div class="form-text">地図をクリックして追加した場合、反映が遅い場合があります</div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.image.id_for_label }}" class="form-label">画像（アップロード）</label>
                        {{ form.image }}
                        {% if form.image.errors %}
                        <div class="text-danger">{{ form.image.errors }}</div>
                        {% endif %}
                        <div class="form-text">JPEG/PNG などの画像をアップロード、または下の「画像URL」を入力してください（どちらかでOK）。</div>
                        <div class="form-text">画像が設定されていない場合は第三者の画像を取得し表示します</div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.image_url.id_for_label }}" class="form-label">画像URL（任意）</label>
                        {{ form.image_url }}
                        {% if form.image_url.errors %}
                        <div class="text-danger">{{ form.image_url.errors }}</div>
                        {% endif %}
                        <div class="form-text">例: https://example.com/path/to/photo.jpg</div>
                        <img id="image-url-preview" class="img-thumbnail mt-2" style="max-width: 200px; display: none;" alt="URLプレビュー">
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'home' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-2"></i>キャンセル
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane me-2"></i>投稿する
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 画像プレビュー機能（安全な参照で実装）
    const imageInput = document.getElementById('id_image');
    if (imageInput) {
        imageInput.addEventListener('change', function(ev) {
            const file = ev.target.files && ev.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(frEv) {
                let preview = document.getElementById('image-preview');
                if (!preview) {
                    preview = document.createElement('img');
                    preview.id = 'image-preview';
                    preview.className = 'img-thumbnail mt-2';
                    preview.style.maxWidth = '200px';
                    imageInput.parentNode.appendChild(preview);
                }
                preview.src = frEv.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // 画像URLプレビュー
    const imageUrlInput = document.getElementById('id_image_url');
    const imageUrlPreview = document.getElementById('image-url-preview');
    if (imageUrlInput && imageUrlPreview) {
        const updateUrlPreview = () => {
            const url = (imageUrlInput.value || '').trim();
            if (url) {
                imageUrlPreview.src = url;
                imageUrlPreview.style.display = 'block';
            } else {
                imageUrlPreview.removeAttribute('src');
                imageUrlPreview.style.display = 'none';
            }
        };
        imageUrlInput.addEventListener('input', updateUrlPreview);
        updateUrlPreview();
    }

    // --- 地図で位置選択 ---
    const mapEl = document.getElementById('pickMap');
    if (!mapEl || typeof L === 'undefined') return; // Leafletロード失敗時は無視

    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');
    const addrInput = document.getElementById('id_address');

    const tokyo = [35.6762, 139.6503];
    const pickMap = L.map('pickMap').setView(tokyo, 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(pickMap);

    let pickMarker = null;
    function setMarker(lat, lng, label) {
        if (pickMarker) pickMap.removeLayer(pickMarker);
        pickMarker = L.marker([lat, lng]);
        if (label) pickMarker.bindPopup(label).openPopup();
        pickMarker.addTo(pickMap);
    }

    function setLatLngFields(lat, lng) {
        if (latInput) latInput.value = lat;
        if (lngInput) lngInput.value = lng;
    }

    function reverseGeocode(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ja`)
            .then(r => r.json())
            .then(d => {
                if (addrInput && d && d.display_name) addrInput.value = d.display_name;
            })
            .catch(() => {});
    }

    pickMap.on('click', function(e) {
        const { lat, lng } = e.latlng;
        setLatLngFields(lat, lng);
        setMarker(lat, lng, 'ここに追加');
        reverseGeocode(lat, lng);
    });

    // 検索
    const searchInput = document.getElementById('placeSearchInput');
    const searchBtn = document.getElementById('placeSearchBtn');
    function runSearch() {
        const q = (searchInput && searchInput.value || '').trim();
        if (!q) return;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&addressdetails=1&accept-language=ja`)
            .then(r => r.json())
            .then(results => {
                if (!results || !results.length) return;
                const top = results[0];
                const lat = parseFloat(top.lat), lon = parseFloat(top.lon);
                pickMap.setView([lat, lon], 15);
                setMarker(lat, lon, top.display_name);
                setLatLngFields(lat, lon);
                if (addrInput) addrInput.value = top.display_name;
            })
            .catch(() => {});
    }
    if (searchBtn) searchBtn.addEventListener('click', runSearch);
    if (searchInput) searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            runSearch();
        }
    });

    // 現在地ボタン
    const geoBtn = document.getElementById('useMyLocationBtn');
    if (geoBtn && 'geolocation' in navigator) {
        geoBtn.addEventListener('click', function() {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                pickMap.setView([lat, lon], 15);
                setMarker(lat, lon, '現在地');
                setLatLngFields(lat, lon);
                reverseGeocode(lat, lon);
            }, function() {
                geoBtn.classList.add('disabled');
            });
        });
    }
});
</script>
{% endblock %}
